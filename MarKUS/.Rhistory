}
)
fe <- filter_ed(filt_shann, threshold = 3, method = "lv", chunk_size = 10,
BPPARAM = BiocParallel::MulticoreParam())
fe
fe <- filter_ed(filt_shann, threshold = 2, method = "lv", chunk_size = 10,
BPPARAM = BiocParallel::MulticoreParam())
fe
fe <- filter_ed(filt_shann, threshold = 1, method = "lv", chunk_size = 10,
BPPARAM = BiocParallel::MulticoreParam())
fe
ck <- count_kmers(df, kmer_size = 20, threads = 10)
for(i in seq_along(ck$kmer_txt)) {
txtlinescmd <- sprintf('wc -l < "%s"',
ck[i, "kmer_txt"])
n_lines <- as.integer(system(txtlinescmd, intern = TRUE))
nseqs$nkmers[i] <- n_lines
}
nseqs
metadata <- data.frame(sample = ck$sample,
group = gsub("_[1-9]", "", ck$sample))
gsk <- get_shared_kmers(obj = ck, data = metadata, group = "group", min_occurrence = 4)
shann <- calculate_shannon(gsk)
filt_shann <- filter_shannon_values(shann$shannon_values,  threshold = 1.8)
shann
gsk
shann <- calculate_shannon(gsk)
shann
ck <- count_kmers(df, kmer_size = 15, threads = 10)
for(i in seq_along(ck$kmer_txt)) {
txtlinescmd <- sprintf('wc -l < "%s"',
ck[i, "kmer_txt"])
n_lines <- as.integer(system(txtlinescmd, intern = TRUE))
nseqs$nkmers[i] <- n_lines
}
metadata <- data.frame(sample = ck$sample,
group = gsub("_[1-9]", "", ck$sample))
gsk <- get_shared_kmers(obj = ck, data = metadata, group = "group", min_occurrence = 4)
shann <- calculate_shannon(gsk)
shann
gsk
ck
ck <- count_kmers(df, kmer_size = 10, threads = 10)
for(i in seq_along(ck$kmer_txt)) {
txtlinescmd <- sprintf('wc -l < "%s"',
ck[i, "kmer_txt"])
n_lines <- as.integer(system(txtlinescmd, intern = TRUE))
nseqs$nkmers[i] <- n_lines
}
gsk <- get_shared_kmers(obj = ck, data = metadata, group = "group", min_occurrence = 4)
gsk
shann <- calculate_shannon(gsk)
shann
filt_shann <- filter_shannon_values(shann$shannon_values,  threshold = 1.8)
filt_shann
filt_shann
filt_shann <- filter_shannon_values(shann$shannon_values,  threshold = 0.5)
filt_shann
nkmers <- data.frame()
for(i in seq_along(gsk)) {
txtlinescmd <- sprintf('wc -l < "%s"',
gsk[i])
n_lines <- as.integer(system(txtlinescmd, intern = TRUE))
nkmers[i, "group"] <- sub("_.*","",basename(gsk[i]))
nkmers[i, "sharedkmers"] <- n_lines
nkmers[i, "sharedkmers"] <- n_lines
nkmers[i, "filtshann"] <- length(filt_shann[[i]])
}
txtlinescmd
nkmers
fe <- filter_ed(filt_shann, threshold = 1, method = "lv", chunk_size = 10,
BPPARAM = BiocParallel::MulticoreParam())
fe
filt_shann
fe <- filter_ed(filt_shann, threshold = 1, method = "hamming", chunk_size = 10,
BPPARAM = BiocParallel::MulticoreParam())
fe
fe <- filter_ed(filt_shann, threshold = 1, method = "hamming", chunk_size = 1,
BPPARAM = BiocParallel::MulticoreParam())
fe
fe <- filter_ed(filt_shann, threshold = 1, method = "hamming", chunk_size = 100,
BPPARAM = BiocParallel::MulticoreParam())
fe
?stringdist
fe <- filter_ed(filt_shann, threshold = 1, method = "dl", chunk_size = 100,
BPPARAM = BiocParallel::MulticoreParam())
fe
fe <- filter_ed(filt_shann, threshold = 1, method = "osa", chunk_size = 100,
BPPARAM = BiocParallel::MulticoreParam())
fe
fe <- filter_ed(filt_shann, threshold = 1, method = "osa", chunk_size = NULL,
BPPARAM = BiocParallel::MulticoreParam())
fe
fe <- filter_ed(filt_shann, threshold = 1, method = "soundex", chunk_size = NULL,
BPPARAM = BiocParallel::MulticoreParam())
fe
fe <- filter_ed(filt_shann, threshold = 1, method = "cosine", chunk_size = NULL,
BPPARAM = BiocParallel::MulticoreParam())
fe
fe <- filter_ed(filt_shann, threshold = 1, method = "lv", chunk_size = NULL,
BPPARAM = BiocParallel::MulticoreParam(), usebytes = F)
filt_shann
names(filt_shann)
for (grp in names(filt_shann)) {
val <- filt_shann[[grp]]
if (!is(val, "DNAStringSet")) {
if (is.character(val) || is.numeric(val)) {
names(val) <- NULL
filt_shann[[grp]] <- Biostrings::DNAStringSet(names(val))
} else {
stop(sprintf(
"Group '%s' is not DNAStringSet, character, or named numeric.",
grp
))
}
}
}
filt_shann
filt_shann
filt_shann <- filter_shannon_values(shann$shannon_values,  threshold = 0.5)
filt_shann
for (grp in names(filt_shann)) {
val <- filt_shann[[grp]]
if (!is(val, "DNAStringSet")) {
if (is.character(val) || is.numeric(val)) {
filt_shann[[grp]] <- Biostrings::DNAStringSet(names(val))
} else {
stop(sprintf(
"Group '%s' is not DNAStringSet, character, or named numeric.",
grp
))
}
}
}
filt_shann
filt_shann
fe <- filter_ed(filt_shann, threshold = 1, method = "lv", chunk_size = NULL,
BPPARAM = BiocParallel::MulticoreParam())
filt_shann
names(filt_shann)
fe <- filter_ed(filt_shann, threshold = 1, method = "lv", chunk_size = NULL,
BPPARAM = BiocParallel::MulticoreParam())
x[[grp]]
## 2) Loop over each focal group
for (grp in names(filt_shann)) {
this_set   <- filt_shann[[grp]]
other_sets <- do.call(c, filt_shann[names(filt_shann) != grp])
other_chr  <- as.character(other_sets)
}
this_set
other_sets
filt_shann[grp]
## 2) Loop over each focal group
for (grp in names(filt_shann)) {
this_set   <- filt_shann[grp]
other_sets <- do.call(c, filt_shann[names(filt_shann) != grp])
other_chr  <- as.character(other_sets)
}
this_set
other_sets
other_chr
other_sets
length(this_set)
split(seq_len(N), ceiling(seq_len(N) / chunk_size))
N <- length(this_set)
seq_len(N)
this_set
length(this_set)
N <- nrow(this_set)
N
nrow(this_set)
N <- length(this_set$Spain)
N
## 2) Loop over each focal group
for (grp in names(filt_shann)) {
this_set   <- filt_shann[[grp]]
other_sets <- do.call(c, filt_shann[names(filt_shann) != grp])
other_chr  <- as.character(other_sets)
}
N <- length(this_set)
N
seq_len(N)
ceiling(seq_len(N) / chunk_size)
idx_chunks <- split(seq_len(N), ceiling(seq_len(N) / 10))
idx_chunks
idx_chunks <- split(seq_len(N), ceiling(seq_len(N) / 10))
keep_list <- BiocParallel::bplapply(idx_chunks, function(idxs) {
chunk_chr <- as.character(this_set[idxs])
Dmat <- stringdist::stringdistmatrix(chunk_chr,
other_chr,
method = method,
nthread = 1)
apply(Dmat, 1, function(r) all(r > threshold))
}, BPPARAM = BPPARAM)
}
keep_list <- BiocParallel::bplapply(idx_chunks, function(idxs) {
chunk_chr <- as.character(this_set[idxs])
Dmat <- stringdist::stringdistmatrix(chunk_chr,
other_chr,
method = method,
nthread = 1)
apply(Dmat, 1, function(r) all(r > threshold))
}, BPPARAM = MulticoreParam(workers = 1))
keep_list <- BiocParallel::bplapply(idx_chunks, function(idxs) {
chunk_chr <- as.character(this_set[idxs])
Dmat <- stringdist::stringdistmatrix(chunk_chr,
other_chr,
method = method,
nthread = 1)
apply(Dmat, 1, function(r) all(r > threshold))
}, BPPARAM = BiocParallel::MulticoreParam(workers = 1))
keep_list <- BiocParallel::bplapply(idx_chunks, function(idxs) {
chunk_chr <- as.character(this_set[idxs])
Dmat <- stringdist::stringdistmatrix(chunk_chr,
other_chr,
method = "lv",
nthread = 1)
apply(Dmat, 1, function(r) all(r > threshold))
}, BPPARAM = BiocParallel::MulticoreParam(workers = 1))
keep_list <- BiocParallel::bplapply(idx_chunks, function(idxs) {
chunk_chr <- as.character(this_set[idxs])
Dmat <- stringdist::stringdistmatrix(chunk_chr,
other_chr,
method = "lv",
nthread = 1)
apply(Dmat, 1, function(r) all(r > 1))
}, BPPARAM = BiocParallel::MulticoreParam(workers = 1))
keep_list
keep_list <- BiocParallel::bplapply(idx_chunks, function(idxs) {
chunk_chr <- as.character(this_set[idxs])
Dmat <- stringdist::stringdistmatrix(chunk_chr,
other_chr,
method = "lv",
nthread = 2)
apply(Dmat, 1, function(r) all(r > 1))
}, BPPARAM = BiocParallel::MulticoreParam(workers = 1))
keep_list
keep_list <- BiocParallel::bplapply(idx_chunks, function(idxs) {
chunk_chr <- as.character(this_set[idxs])
Dmat <- stringdist::stringdistmatrix(chunk_chr,
other_chr,
method = "lv",
nthread = 3)
apply(Dmat, 1, function(r) all(r > 1))
}, BPPARAM = BiocParallel::MulticoreParam(workers = 1))
keep_list
keep_list <- BiocParallel::bplapply(idx_chunks, function(idxs) {
chunk_chr <- as.character(this_set[idxs])
Dmat <- stringdist::stringdistmatrix(chunk_chr,
other_chr,
method = "lv",
nthread = 1)
apply(Dmat, 1, function(r) all(r > 2))
}, BPPARAM = BiocParallel::MulticoreParam(workers = 1))
keep_list
keep_list <- BiocParallel::bplapply(idx_chunks, function(idxs) {
chunk_chr <- as.character(this_set[idxs])
Dmat <- stringdist::stringdistmatrix(chunk_chr,
other_chr,
method = "lv",
nthread = 1)
apply(Dmat, 1, function(r) all(r > 3))
}, BPPARAM = BiocParallel::MulticoreParam(workers = 1))
keep_list
keep_list <- BiocParallel::bplapply(idx_chunks, function(idxs) {
chunk_chr <- as.character(this_set[idxs])
Dmat <- stringdist::stringdistmatrix(chunk_chr,
other_chr,
method = "lv",
nthread = 1)
apply(Dmat, 1, function(r) all(r > 6))
}, BPPARAM = BiocParallel::MulticoreParam(workers = 1))
keep_list
filt_shann
filt_shann <- filter_shannon_values(shann$shannon_values,  threshold = 0.5)
filt_shann
setMethod("filter_ed",
signature("vector"),
function(x,
threshold   = 3,
method      = "lv",
chunk_size  = 500,
BPPARAM     = BiocParallel::MulticoreParam()) {
## 1) Sanityâ€checks & coercion
if (is.null(names(x)) || any(names(x) == "")) {
stop("`x` must be a named vector or named list")
}
# Convert each element into DNAStringSet of its names()
groups <- lapply(x, function(elem) {
if (methods::is(elem, "DNAStringSet")) {
elem
} else if (is.character(elem) || is.numeric(elem)) {
seqs <- names(elem)
if (is.null(seqs)) {
stop("When `x` element is vector, it must have names()")
}
Biostrings::DNAStringSet(seqs)
} else {
stop("Each element of `x` must be DNAStringSet, character or named vector")
}
})
names(groups) <- names(x)
result_list <- list()
## 2) Loop over each focal group
for (grp in names(groups)) {
this_set   <- groups[[grp]]
other_sets <- do.call(c, groups[names(groups) != grp])
other_chr  <- as.character(other_sets)
N <- length(this_set)
idx_chunks <- split(seq_len(N), ceiling(seq_len(N) / chunk_size))
## 3) Parallel chunk processing
keep_chunks <- BiocParallel::bplapply(idx_chunks, function(idxs) {
chunk_chr <- as.character(this_set[idxs])
Dmat <- stringdist::stringdistmatrix(
a       = chunk_chr,
b       = other_chr,
method  = method,
nthread = 1
)
apply(Dmat, 1, function(r) all(r > threshold))
}, BPPARAM = BPPARAM)
keep_idx <- unlist(keep_chunks, use.names = FALSE)
## 4) Collect survivors
if (any(keep_idx)) {
result_list[[grp]] <- S4Vectors::DataFrame(
sequence = this_set[keep_idx],
group    = rep(grp, sum(keep_idx))
)
}
}
## 5) Bind and return
if (length(result_list) == 0L) {
return(S4Vectors::DataFrame(
sequence = Biostrings::DNAStringSet(),
group    = character()
))
}
do.call(S4Vectors::rbind, result_list)
}
)
fe <- filter_ed(filt_shann, threshold = 1, method = "lv", chunk_size = NULL,
BPPARAM = BiocParallel::MulticoreParam())
filt_shann
fe <- filter_ed(filt_shann, threshold = 1, method = "lv", chunk_size = NULL,
BPPARAM = BiocParallel::MulticoreParam())
fe <- filter_ed(filt_shann, threshold = 1, method = "lv", chunk_size = 10,
BPPARAM = BiocParallel::MulticoreParam())
fe
fe <- filter_ed(filt_shann, threshold = 1, method = "lv", chunk_size = 1,
BPPARAM = BiocParallel::MulticoreParam())
fe
fe <- filter_ed(filt_shann, threshold = 2, method = "lv", chunk_size = 1,
BPPARAM = BiocParallel::MulticoreParam())
fe
fe <- filter_ed(filt_shann, threshold = 3, method = "lv", chunk_size = 1,
BPPARAM = BiocParallel::MulticoreParam())
fe
fe <- filter_ed(filt_shann, threshold = 8, method = "lv", chunk_size = 1,
BPPARAM = BiocParallel::MulticoreParam())
fe
filter_ed <- function(filt_shann, threshold = 3, method = "lv", chunk_size = 10, BPPARAM = BiocParallel::MulticoreParam()) {
filt_final <- list()
for (group in names(filt_shann)) {
cat("Processing", group, "\n")
kmer_vec <- names(filt_shann[[group]])
this_set <- DNAStringSet(kmer_vec)
N <- length(this_set)
if (N == 0) {
filt_final[[group]] <- character(0)
next
}
if (chunk_size >= N) {
idx_chunks <- list(seq_len(N))
} else {
idx_chunks <- split(seq_len(N), ceiling(seq_len(N) / chunk_size))
}
keep <- bplapply(idx_chunks, function(chunk_idx) {
chunk <- as.character(this_set[chunk_idx])
rest <- as.character(this_set[-chunk_idx])
mat <- stringdistmatrix(chunk, rest, method = method)
keep_idx <- apply(mat, 1, function(d) all(d > threshold))  # THIS is the key
return(chunk[keep_idx])
}, BPPARAM = BPPARAM)
filt_final[[group]] <- unlist(keep, use.names = FALSE)
}
return(filt_final)
}
fe <- filter_ed(filt_shann, threshold = 8, method = "lv", chunk_size = 1,
BPPARAM = BiocParallel::MulticoreParam())
library(Biostrings)
fe <- filter_ed(filt_shann, threshold = 8, method = "lv", chunk_size = 1,
BPPARAM = BiocParallel::MulticoreParam())
library(BiocParallel)
fe <- filter_ed(filt_shann, threshold = 8, method = "lv", chunk_size = 1,
BPPARAM = BiocParallel::MulticoreParam())
library(stringdist)
fe <- filter_ed(filt_shann, threshold = 8, method = "lv", chunk_size = 1,
BPPARAM = BiocParallel::MulticoreParam())
fe
fe <- filter_ed(filt_shann, threshold = 2, method = "lv", chunk_size = 1,
BPPARAM = BiocParallel::MulticoreParam())
fe
fe <- filter_ed(filt_shann, threshold = 3, method = "lv", chunk_size = 1,
BPPARAM = BiocParallel::MulticoreParam())
fe
filt_shann
detach("package:Biostrings", unload = TRUE)
detach("package:BiocParallel", unload = TRUE)
detach("package:stringdist", unload = TRUE)
document()
rm(filter_ed())
rm(filter_ed)
rm(count_kmers)
#test pacchetto
fls <- list.files(path = "../../MarKUS_sample_data")
pths <- list.files(path = "../../MarKUS_sample_data", full.names = T)
fls
pths
nseqs <- data.frame()
for(i in seq_along(df$merged_path)) {
fastq <- ShortRead::readFastq(df[i, "merged_path"])
smpl <- df[i, "sample"]
nseqs[i, "sample"] <- smpl
nseqs[i, "nlines"] <- length(fastq)
}
df <- data.frame(sample = gsub(".fastq","",fls),
merged_path = pths)
df
pths
pths <- list.files(path = "../../MarKUS_sample_data.*.fastq", full.names = T)
pths
pths <- list.files(path = "../../MarKUS_sample_data*.fastq", full.names = T)
pths
pths <- list.files(path = "../../MarKUS_sample_data/*.fastq", full.names = T)
pths
fls
#test pacchetto
fls <- list.files(path = "../../MarKUS_sample_data", pattern = "fastq")
fls
pths <- list.files(path = "../../MarKUS_sample_data", full.names = T, pattern = "fastq")
pths
df <- data.frame(sample = gsub(".fastq","",fls),
merged_path = pths)
df
nseqs <- data.frame()
for(i in seq_along(df$merged_path)) {
fastq <- ShortRead::readFastq(df[i, "merged_path"])
smpl <- df[i, "sample"]
nseqs[i, "sample"] <- smpl
nseqs[i, "nlines"] <- length(fastq)
}
nseqs
ck <- count_kmers(df, kmer_size = 10, threads = 10)
ck
for(i in seq_along(ck$kmer_txt)) {
txtlinescmd <- sprintf('wc -l < "%s"',
ck[i, "kmer_txt"])
n_lines <- as.integer(system(txtlinescmd, intern = TRUE))
nseqs$nkmers[i] <- n_lines
}
nseqs
metadata <- data.frame(sample = ck$sample,
group = gsub("_[1-9]", "", ck$sample))
gsk <- get_shared_kmers(obj = ck, data = metadata, group = "group", min_occurrence = 4)
gsk
shann <- calculate_shannon(gsk)
shann
filt_shann <- filter_shannon_values(shann$shannon_values,  threshold = 1.8)
filt_shann
nkmers <- data.frame()
for(i in seq_along(gsk)) {
txtlinescmd <- sprintf('wc -l < "%s"',
gsk[i])
n_lines <- as.integer(system(txtlinescmd, intern = TRUE))
nkmers[i, "group"] <- sub("_.*","",basename(gsk[i]))
nkmers[i, "sharedkmers"] <- n_lines
nkmers[i, "sharedkmers"] <- n_lines
nkmers[i, "filtshann"] <- length(filt_shann[[i]])
}
nkmers
fe <- filter_ed(filt_shann, threshold = 3, method = "lv", chunk_size = 1,
BPPARAM = BiocParallel::MulticoreParam())
fe
filt_shann <- filter_shannon_values(shann$shannon_values,  threshold = 2)
filt_shann
filt_shann <- filter_shannon_values(shann$shannon_values,  threshold = 1.9)
filt_shann
nkmers <- data.frame()
for(i in seq_along(gsk)) {
txtlinescmd <- sprintf('wc -l < "%s"',
gsk[i])
n_lines <- as.integer(system(txtlinescmd, intern = TRUE))
nkmers[i, "group"] <- sub("_.*","",basename(gsk[i]))
nkmers[i, "sharedkmers"] <- n_lines
nkmers[i, "sharedkmers"] <- n_lines
nkmers[i, "filtshann"] <- length(filt_shann[[i]])
}
fe <- filter_ed(filt_shann, threshold = 3, method = "lv", chunk_size = 1,
BPPARAM = BiocParallel::MulticoreParam())
fe
fe <- filter_ed(filt_shann, threshold = 2, method = "lv", chunk_size = 1,
BPPARAM = BiocParallel::MulticoreParam())
fe
fe <- filter_ed(filt_shann, threshold = 6, method = "lv", chunk_size = 1,
BPPARAM = BiocParallel::MulticoreParam())
fe
fe <- filter_ed(filt_shann, threshold = 1, method = "lv", chunk_size = 1,
BPPARAM = BiocParallel::MulticoreParam())
fe
fe <- filter_ed(filt_shann, threshold = 3, method = "lv", chunk_size = 1,
BPPARAM = BiocParallel::MulticoreParam())
fe
